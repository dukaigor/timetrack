<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evidență Lucrători – Time & Attendance (Firebase)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Light + Liquid Glass */
      --bg:#f6f7f9;
      --text:#0f172a;
      --muted:#64748b;
      --card:rgba(255,255,255,.7);
      --card-border:rgba(15,23,42,.06);
      --ring:0 0 0 3px rgba(59,130,246,.25);
      --accent:#2563eb;
      --success:#16a34a;
      --danger:#dc2626;
      --warning:#f59e0b;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--text)}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:20px;font-weight:700;letter-spacing:.2px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;border:1px solid #c7d2fe}
    .card{background:var(--card);backdrop-filter: blur(12px) saturate(140%);-webkit-backdrop-filter: blur(12px) saturate(140%);border:1px solid var(--card-border);
      border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--card-border);background:rgba(255,255,255,.65);color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .tab.active{background:white;border-color:#bfdbfe;box-shadow:var(--ring)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button,textarea{font-family:inherit}
    .input{width:100%;background:white;border:1px solid var(--card-border);color:var(--text);
      padding:10px 12px;border-radius:12px;outline:none}
    .input:focus{border-color:#bfdbfe;box-shadow:var(--ring)}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);color:white}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);color:white}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);color:white}
    .btn.ghost{background:rgba(255,255,255,.65);color:var(--text);border:1px solid var(--card-border)}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:white}
    .row{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--card-border);text-align:left}
    th{font-size:12px;color:#2563eb;text-transform:uppercase;letter-spacing:.08em}
    .kpi{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .kpi h3{margin:0;font-size:22px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(37,99,235,.08);border:1px solid #bfdbfe;font-size:12px;color:#1e3a8a}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--card-border),transparent);margin:14px 0}
    .footer{margin-top:18px;font-size:12px;color:var(--muted)}
    .link{color:#2563eb;text-decoration:none}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(59,130,246,.12);border:1px solid #bfdbfe;color:#1d4ed8;font-size:12px}
    .hidden{display:none !important}
    /* Employee picker (circle + photo) */
    .emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(86px,1fr));gap:10px}
    .emp{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px;border-radius:14px;background:rgba(255,255,255,.6);border:1px solid var(--card-border);cursor:pointer;transition:.15s}
    .emp:hover{box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .emp.selected{box-shadow:0 0 0 3px rgba(34,197,94,.25);border-color:#86efac}
    .emp img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #e2e8f0;background:#fff}
    .emp-name{font-size:12px;text-align:center;line-height:1.1}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#e2e8f0;border:1px solid #cbd5e1}
    .status-dot.on{background:#22c55e;border-color:#16a34a}
    /* Modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.25);backdrop-filter:blur(6px)}
    .modal-card{background:white;border-radius:16px;padding:18px 16px;min-width:300px;border:1px solid var(--card-border);box-shadow:0 15px 40px rgba(15,23,42,.15)}
    .header-row{display:flex;align-items:center;gap:10px}
    .lang{display:flex;gap:8px;align-items:center}
    .lang select{background:white;border:1px solid var(--card-border);border-radius:10px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:38px;height:38px;border-radius:10px;background:radial-gradient(60% 60% at 30% 20%, #93c5fd, transparent),radial-gradient(60% 60% at 80% 70%, #22c55e, transparent);border:1px solid rgba(15,23,42,.15);"></div>
        <div>
          <div class="title" data-i18n="app_title">Evidență Lucrători — Time & Attendance (Firebase)</div>
          <div class="muted" style="font-size:12px" data-i18n="subtitle">Datele sunt salvate în Firebase Realtime Database. Export/Import opțional pentru backup local.</div>
        </div>
      </div>
      <div class="header-row">
        <div class="lang">
          <label for="langSel" class="muted" style="font-size:12px" data-i18n="lang">Limbă</label>
          <select id="langSel">
            <option value="ro">Română</option>
            <option value="it">Italiană</option>
          </select>
        </div>
        <span class="badge" id="version"></span>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <button class="tab active" id="tab-dashboard" onclick="switchTab('dashboard')" data-i18n="tab_dashboard">Panou lucru</button>
      <button class="tab" id="tab-admin" onclick="switchTab('admin')" data-i18n="tab_admin">Admin</button>
      <button class="tab" id="tab-reports" onclick="switchTab('reports')" data-i18n="tab_reports">Rapoarte</button>
    </div>

    <!-- DASHBOARD -->
    <section id="view-dashboard" class="card" role="tabpanel" aria-labelledby="tab-dashboard">
      <div class="grid grid-2">
        <div>
          <h2 style="margin:0 0 8px 0" data-i18n="quick_time">Pontaj rapid</h2>
          <div class="row" style="align-items:start">
            <div style="flex:1;min-width:260px">
              <label data-i18n="worker">Lucrător</label>
              <div id="employee-grid" class="emp-grid"></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;min-width:220px">
              <button class="btn success" id="btn-clock" onclick="toggleClock()" data-i18n="btn_checkin">Înregistrează intrarea</button>
              <button class="btn ghost" onclick="addNowEntryForAll()" title="Intrare pentru toți activii" data-i18n="btn_checkin_all">Intrare toți</button>
            </div>
            <div class="spacer"></div>
          </div>

          <div class="hr"></div>
          <div class="kpi">
            <div>
              <div class="muted" style="font-size:12px" data-i18n="status">Stare</div>
              <h3 id="kpi-state">—</h3>
            </div>
            <span class="pill" id="kpi-live" data-i18n-dyn="live_duration">Durată curentă: 00:00</span>
            <span class="pill" id="kpi-last" data-i18n-dyn="last_session">Ultima sesiune: —</span>
          </div>
          <div class="footer" data-i18n="tip_timer">Sfat: poți lăsa aplicația deschisă; timerul se actualizează în timp real.</div>
        </div>

        <div>
          <h2 style="margin:0 0 8px 0" data-i18n="today_title">Pontajul de azi (selectat)</h2>
          <table>
            <thead>
              <tr><th data-i18n="date">Data</th><th data-i18n="start">Start</th><th data-i18n="end">Stop</th><th data-i18n="duration">Durată</th><th></th></tr>
            </thead>
            <tbody id="today-rows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="card hidden" role="tabpanel" aria-labelledby="tab-admin">
      <h2 style="margin-top:0" data-i18n="admin_title">Administrează lucrători</h2>
      <!-- Admin lock -->
      <div id="admin-lock" class="row" style="align-items:center">
        <input id="admin-pass" class="input" type="password" placeholder="Parolă Admin" />
        <button class="btn primary" onclick="unlockAdmin()" data-i18n="unlock">Deschide Admin</button>
      </div>
      <div id="admin-content" class="hidden">
        <div class="grid grid-2">
          <div>
            <div class="row">
              <div style="flex:1;min-width:180px">
                <label data-i18n="name">Nume</label>
                <input id="emp-name" class="input" placeholder="ex: Ion Popescu" />
              </div>
              <div style="flex:1;min-width:160px">
                <label data-i18n="role">Funcția (opțional)</label>
                <input id="emp-role" class="input" placeholder="ex: Operator" />
              </div>
              <div style="width:140px">
                <label data-i18n="rate">Tarif/oră (opțional)</label>
                <input id="emp-rate" type="number" min="0" step="0.01" class="input" placeholder="ex: 5" />
              </div>
              <button class="btn primary" onclick="createEmployee()" data-i18n="add">Adaugă</button>
            </div>

            <div class="hr"></div>
            <table>
              <thead>
                <tr><th data-i18n="name">Nume</th><th data-i18n="role">Funcția</th><th data-i18n="rate_short">Tarif</th><th data-i18n="state">Stare</th><th style="width:240px" data-i18n="actions">Acțiuni</th></tr>
              </thead>
              <tbody id="emp-rows"></tbody>
            </table>

            <div class="row" style="margin-top:14px">
              <button class="btn ghost" onclick="exportData()" data-i18n="export_backup">Exportă Backup (.json)</button>
              <label class="btn ghost" for="import-file" style="cursor:pointer" data-i18n="import_backup">Importă Backup</label>
              <input id="import-file" type="file" accept="application/json" class="hidden" />
              <button class="btn warn" onclick="resetAll()" data-i18n="reset_all">Resetare totală</button>
              <div class="spacer"></div>
              <span class="chip" data-i18n-dyn="total_employees">Total lucrători: <b id="emp-count" style="margin-left:6px">0</b></span>
            </div>
          </div>

          <div>
            <h3 style="margin:0 0 8px 0" data-i18n="manual_entries">Intrări rapide (manual)</h3>
            <div class="row">
              <div style="flex:1;min-width:220px">
                <label data-i18n="worker">Lucrător</label>
                <select id="manual-employee" class="input"></select>
              </div>
              <div style="width:170px">
                <label data-i18n="date">Data</label>
                <input id="manual-date" type="date" class="input" />
              </div>
              <div style="width:130px">
                <label data-i18n="start">Start</label>
                <input id="manual-start" type="time" class="input" />
              </div>
              <div style="width:130px">
                <label data-i18n="end">Stop</label>
                <input id="manual-end" type="time" class="input" />
              </div>
              <button class="btn primary" onclick="addManualEntry()" data-i18n="add_session">Adaugă sesiune</button>
            </div>
            <div class="footer" data-i18n="manual_hint">Pentru zile trecute sau corecții (nu se suprapun peste o sesiune activă).</div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px 0" data-i18n="autoout_title">Ieșire automată</h3>
            <div class="row">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="autoout-enabled" /> <span data-i18n="autoout_enable">Activează ieșire automată</span>
              </label>
              <div style="width:140px">
                <label data-i18n="autoout_time">Ora (ex: 18:00)</label>
                <input id="autoout-time" type="time" class="input" value="18:00" />
              </div>
              <button class="btn primary" onclick="saveAutoOut()" data-i18n="save">Salvează</button>
            </div>
            <div class="footer" data-i18n="autoout_hint">Dacă un lucrător nu apasă ieșire, sesiunea se închide automat la ora setată.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="view-reports" class="card hidden" role="tabpanel" aria-labelledby="tab-reports">
      <h2 style="margin-top:0" data-i18n="reports">Rapoarte</h2>
      <div class="row">
        <div style="min-width:220px;flex:1">
          <label data-i18n="worker">Lucrător</label>
          <select id="rep-employee" class="input"></select>
        </div>
        <div style="min-width:220px">
          <label data-i18n="period">Perioadă</label>
          <select id="rep-range" class="input" onchange="toggleCustomDates()">
            <option value="thisWeek" data-i18n="thisWeek">Săptămâna aceasta</option>
            <option value="lastWeek" data-i18n="lastWeek">Săptămâna trecută</option>
            <option value="thisMonth" data-i18n="thisMonth" selected>Luna aceasta</option>
            <option value="lastMonth" data-i18n="lastMonth">Luna trecută</option>
            <option value="thisYear" data-i18n="thisYear">Anul acesta</option>
            <option value="custom" data-i18n="custom">Personalizat</option>
          </select>
        </div>
        <div id="rep-custom" class="row hidden" style="min-width:360px">
          <div style="width:170px">
            <label data-i18n="from">De la</label>
            <input id="rep-from" type="date" class="input" />
          </div>
          <div style="width:170px">
            <label data-i18n="to">Până la</label>
            <input id="rep-to" type="date" class="input" />
          </div>
        </div>
        <button class="btn primary" onclick="runReport()" data-i18n="generate">Generează</button>
        <button class="btn ghost" onclick="exportCSV()" data-i18n="export_csv">Export CSV</button>
        <button class="btn ghost" onclick="window.print()" data-i18n="print">Print</button>
        <div class="spacer"></div>
      </div>

      <div class="hr"></div>
      <div id="rep-summary" class="kpi"></div>

      <div class="hr"></div>
      <table>
        <thead>
          <tr><th data-i18n="worker">Lucrător</th><th data-i18n="date">Data</th><th data-i18n="start">Start</th><th data-i18n="end">Stop</th><th data-i18n="duration">Durată</th></tr>
        </thead>
        <tbody id="rep-rows"></tbody>
      </table>
    </section>

    <div class="footer" data-i18n="footnote">Creat pentru uz local. Pentru server multi‑utilizator (rețea & logare), se poate extinde ulterior (API/DB).</div>
  </div>

  <script type="module">
  // ===== Firebase Setup =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, update, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA6E5Xn5RvZViYJW-hxh3pn8w1ALDZpOb4",
    authDomain: "vmh-tracker.firebaseapp.com",
    databaseURL: "https://vmh-tracker-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "vmh-tracker",
    storageBucket: "vmh-tracker.appspot.com",
    messagingSenderId: "1036108389148",
    appId: "1:1036108389148:web:2add2da83a2759913138d9"
  };
  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);
  const auth = getAuth(app);

  // ===== I18N (RO/IT) =====
  const STR = {
    ro: {
      app_title:"Evidență Lucrători — Time & Attendance (Firebase)", subtitle:"Datele sunt salvate în Firebase Realtime Database. Export/Import opțional pentru backup local.", lang:"Limbă", tab_dashboard:"Panou lucru", tab_admin:"Admin", tab_reports:"Rapoarte", quick_time:"Pontaj rapid", worker:"Lucrător", btn_checkin:"Înregistrează intrarea", btn_checkin_all:"Intrare toți", status:"Stare", tip_timer:"Sfat: poți lăsa aplicația deschisă; timerul se actualizează în timp real.", today_title:"Pontajul de azi (selectat)", date:"Data", start:"Start", end:"Stop", duration:"Durată", admin_title:"Administrează lucrători", unlock:"Deschide Admin", name:"Nume", role:"Funcția (opțional)", rate:"Tarif/oră (opțional)", rate_short:"Tarif", add:"Adaugă", state:"Stare", actions:"Acțiuni", export_backup:"Exportă Backup (.json)", import_backup:"Importă Backup", reset_all:"Resetare totală", manual_entries:"Intrări rapide (manual)", add_session:"Adaugă sesiune", manual_hint:"Pentru zile trecute sau corecții (nu se suprapun peste o sesiune activă).", autoout_title:"Ieșire automată", autoout_enable:"Activează ieșire automată", autoout_time:"Ora (ex: 18:00)", save:"Salvează", autoout_hint:"Dacă un lucrător nu apasă ieșire, sesiunea se închide automat la ora setată.", reports:"Rapoarte", period:"Perioadă", thisWeek:"Săptămâna aceasta", lastWeek:"Săptămâna trecută", thisMonth:"Luna aceasta", lastMonth:"Luna trecută", thisYear:"Anul acesta", custom:"Personalizat", from:"De la", to:"Până la", generate:"Generează", export_csv:"Export CSV", print:"Print", footnote:"Creat pentru uz local. Pentru server multi‑utilizator (rețea & logare), se poate extinde ulterior (API/DB)."
    },
    it: {
      app_title:"Registro Dipendenti — Time & Attendance (Firebase)", subtitle:"I dati sono salvati su Firebase Realtime Database. Backup locale opzionale (export/import).", lang:"Lingua", tab_dashboard:"Pannello", tab_admin:"Admin", tab_reports:"Report", quick_time:"Timbratura rapida", worker:"Dipendente", btn_checkin:"Registra entrata/uscita", btn_checkin_all:"Entrata per tutti", status:"Stato", tip_timer:"Suggerimento: puoi lasciare l'app aperta; il timer si aggiorna in tempo reale.", today_title:"Timbrature di oggi (selezionato)", date:"Data", start:"Inizio", end:"Fine", duration:"Durata", admin_title:"Gestisci dipendenti", unlock:"Apri Admin", name:"Nome", role:"Ruolo (opz.)", rate:"Tariffa/ora (opz.)", rate_short:"Tariffa", add:"Aggiungi", state:"Stato", actions:"Azioni", export_backup:"Esporta Backup (.json)", import_backup:"Importa Backup", reset_all:"Reset totale", manual_entries:"Inserimenti rapidi (manuale)", add_session:"Aggiungi sessione", manual_hint:"Per giorni passati o correzioni (non si sovrappone a una sessione attiva).", autoout_title:"Uscita automatica", autoout_enable:"Abilita uscita automatica", autoout_time:"Ora (es: 18:00)", save:"Salva", autoout_hint:"Se un dipendente non registra l'uscita, la sessione si chiude all'ora impostata.", reports:"Report", period:"Periodo", thisWeek:"Questa settimana", lastWeek:"Settimana scorsa", thisMonth:"Questo mese", lastMonth:"Mese scorso", thisYear:"Quest'anno", custom:"Personalizzato", from:"Da", to:"A", generate:"Genera", export_csv:"Esporta CSV", print:"Stampa", footnote:"Creato per uso locale. Per multi‑utente (rete & login) si può estendere (API/DB)."
    }
  };
  function applyI18n(){
    const lang = localStorage.getItem('lang')||'ro';
    document.documentElement.lang = lang;
    document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(STR[lang][k]) el.textContent = STR[lang][k]; });
    document.getElementById('btn-clock').textContent = STR[lang].btn_checkin;
    document.querySelectorAll('#rep-range option').forEach(opt=>{ const k=opt.getAttribute('data-i18n'); if(k && STR[lang][k]) opt.textContent = STR[lang][k]; });
  }
  document.getElementById('langSel').addEventListener('change', (e)=>{ localStorage.setItem('lang', e.target.value); applyI18n(); refreshDashboard(); renderEmployees(); renderEmployeePicker(); });

  // ===== App State =====
  const APP_VERSION = 'v1.2.2-firebase';
  const ADMIN_PASS = '1309';
  let isAdmin = sessionStorage.getItem('isAdmin')==='1';
  const now = () => new Date();
  const fmtDate = (d)=> new Intl.DateTimeFormat('ro-RO',{year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
  const fmtTime = (d)=> new Intl.DateTimeFormat('ro-RO',{hour:'2-digit',minute:'2-digit',hour12:false}).format(d);
  const gid = () => Math.random().toString(36).slice(2,10);
  let dbCache = { employees: [], entries: [], lastEmployeeId: null, autoOut: { enabled:false, time:"18:00" } };
  let EMP_NODE = 'employees'; // auto-switch to 'workers' if present
  const objToArr = (o)=> Object.values(o||{});

  // ===== CRUD Employees =====
  async function upsertEmployee(emp){ await set(ref(rtdb, `${EMP_NODE}/${emp.id}`), emp); }
  async function deleteEmployeeFB(id){ await remove(ref(rtdb, `${EMP_NODE}/${id}`)); }
  async function toggleActiveFB(id, active){ await update(ref(rtdb, `${EMP_NODE}/${id}`), { active }); }

  // ===== CRUD Entries =====
  async function addEntryFB(entry){ await set(ref(rtdb, `entries/${entry.id}`), entry); }
  async function updateEntryFB(entry){ await set(ref(rtdb, `entries/${entry.id}`), entry); }
  async function removeEntryFB(id){ await remove(ref(rtdb, `entries/${id}`)); }

  // ===== Meta =====
  async function setLastEmployeeId(id){ await set(ref(rtdb, 'meta/lastEmployeeId'), id ?? null); }
  async function saveAutoOut(){
    const enabled = document.getElementById('autoout-enabled').checked;
    const time = document.getElementById('autoout-time').value || '18:00';
    await set(ref(rtdb, 'meta/autoOut'), { enabled, time });
    alert('Salvat.');
  }
  window.saveAutoOut = saveAutoOut;

  // ===== Local query helpers =====
  function activeEntryFor(empId){ return dbCache.entries.find(e=>e.employeeId===empId && e.end==null); }
  function entriesFor(empId){ return dbCache.entries.filter(e=>e.employeeId===empId); }
  function todayEntriesFor(empId){ const t=new Date(); t.setHours(0,0,0,0); const u=new Date(t); u.setDate(u.getDate()+1); return dbCache.entries.filter(e=>e.employeeId===empId && new Date(e.start)>=t && new Date(e.start)<u); }

  // ===== Employee Picker (circle + photo) =====
  function renderEmployeePicker(){
    const grid = document.getElementById('employee-grid'); if(!grid) return;
    const selId = dbCache.lastEmployeeId || dbCache.employees[0]?.id || '';
    grid.innerHTML = dbCache.employees.map(e=>{
      const photo = e.imageUrl || e.photoURL || e.photo || e.avatar || '';
      const sel = e.id===selId ? 'selected' : '';
      const on = !!activeEntryFor(e.id);
      return `<div class="emp ${sel}" onclick="selectEmployee('${e.id}')" title="${e.name}">
        <div class="status-dot ${on?'on':''}"></div>
        <img src="${photo}" alt="${e.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'56\'><rect width=\'100%\' height=\'100%\' fill=\'%23e5e7eb\'/><text x=\'50%\' y=\'54%\' text-anchor=\'middle\' font-size=\'10\' fill=\'%236b7280\'>No Photo</text></svg>'" />
        <div class="emp-name">${e.name}</div>
      </div>`
    }).join('');
  }
  window.renderEmployeePicker = renderEmployeePicker;
  function selectEmployee(id){ dbCache.lastEmployeeId = id; setLastEmployeeId(id); refreshDashboard(); renderEmployeePicker(); }
  window.selectEmployee = selectEmployee;

  // ===== Populate selects used in Admin/Reports =====
  function populateEmployeeSelects(){
    const options = dbCache.employees.map(e=>`<option value="${e.id}">${e.name}${e.active===false?' (inactiv)':''}</option>`).join('');
    const manual = document.getElementById('manual-employee'); if(manual) manual.innerHTML = options;
    const rep = document.getElementById('rep-employee'); if(rep) rep.innerHTML = `<option value="all">Toți</option>` + options;
  }
  window.populateEmployeeSelects = populateEmployeeSelects;

  // ===== UI Helpers =====
  function switchTab(tab){
    if(tab==='admin' && !isAdmin){ document.getElementById('admin-lock').classList.remove('hidden'); document.getElementById('admin-content').classList.add('hidden'); }
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    document.querySelectorAll('[id^=view-]').forEach(v=>v.classList.add('hidden'));
    document.getElementById('view-'+tab).classList.remove('hidden');
    if(tab==='reports') runReport();
    if(tab==='dashboard') { refreshDashboard(); renderEmployeePicker(); }
    if(tab==='admin') { renderEmployees(); populateEmployeeSelects(); }
  }
  window.switchTab = switchTab;

  function unlockAdmin(){
    const pass = document.getElementById('admin-pass').value.trim();
    if(pass===ADMIN_PASS){ isAdmin=true; sessionStorage.setItem('isAdmin','1'); document.getElementById('admin-lock').classList.add('hidden'); document.getElementById('admin-content').classList.remove('hidden'); }
    else { alert('Parolă greșită.'); }
  }
  window.unlockAdmin = unlockAdmin;

  async function toggleClock(){
    const empId = dbCache.lastEmployeeId || dbCache.employees[0]?.id;
    if(!empId){ alert('Selectează un lucrător.'); return; }
    const active = activeEntryFor(empId);
    if(active){ active.end = now().toISOString(); await updateEntryFB(active); }
    else { await addEntryFB({ id: gid(), employeeId: empId, start: now().toISOString(), end: null }); }
    await setLastEmployeeId(empId);
    refreshDashboard(); runReport(); renderEmployeePicker();
  }
  window.toggleClock = toggleClock;

  async function addNowEntryForAll(){
    const activeIds = dbCache.employees.filter(e=>e.active!==false).map(e=>e.id);
    const t = now().toISOString();
    for(const id of activeIds){ if(!activeEntryFor(id)) await addEntryFB({ id: gid(), employeeId: id, start: t, end: null }); }
    refreshDashboard(); renderEmployeePicker();
  }
  window.addNowEntryForAll = addNowEntryForAll;

  function refreshDashboard(){
    const empId = dbCache.lastEmployeeId || (dbCache.employees[0]?.id || '');
    if(!empId){ document.getElementById('kpi-state').textContent='—'; return; }
    const emp = dbCache.employees.find(e=>e.id===empId);
    const active = activeEntryFor(empId);
    const btn = document.getElementById('btn-clock');
    if(active){ document.getElementById('kpi-state').textContent = `${emp.name} este ÎN PROGRAM`; btn.classList.remove('success'); btn.classList.add('danger'); btn.textContent = (localStorage.getItem('lang')||'ro')==='it' ? 'Registra uscita' : 'Înregistrează ieșirea'; }
    else { document.getElementById('kpi-state').textContent = `${emp.name} este ÎN AFARA PROGRAMULUI`; btn.classList.add('success'); btn.classList.remove('danger'); btn.textContent = (localStorage.getItem('lang')||'ro')==='it' ? 'Registra entrata' : 'Înregistrează intrarea'; }

    const empEntries = entriesFor(empId).filter(e=>e.end!=null).sort((a,b)=>new Date(b.end)-new Date(a.end));
    const last = empEntries[0];
    const lang = localStorage.getItem('lang')||'ro';
    const lastLabel = lang==='it' ? 'Ultima:' : 'Ultima:';
    const liveLabel = lang==='it' ? 'Durata attuale:' : 'Durată curentă:';
    document.getElementById('kpi-last').textContent = last ? `${lastLabel} ${fmtDate(new Date(last.start))}, ${fmtTime(new Date(last.start))} – ${fmtTime(new Date(last.end))} (${fmtDuration(durationOf(last))})` : (lang==='it'?'Ultima sessione: —':'Ultima sesiune: —');
    const activeEntry = activeEntryFor(empId);
    document.getElementById('kpi-live').textContent = `${liveLabel} ` + (activeEntry? fmtDuration(durationOf(activeEntry)) : '00:00');

    const rows = todayEntriesFor(empId).sort((a,b)=>new Date(a.start)-new Date(b.start)).map(e=>{
      const d = new Date(e.start);
      return `<tr>
        <td>${fmtDate(d)}</td>
        <td>${fmtTime(new Date(e.start))}</td>
        <td>${e.end?fmtTime(new Date(e.end)):'—'}</td>
        <td>${fmtDuration(durationOf(e))}</td>
        <td><button class="btn ghost" onclick="editEntry('${e.id}')">Edit</button> <button class="btn ghost" onclick="removeEntry('${e.id}')">Delete</button></td>
      </tr>`;
    }).join('');
    document.getElementById('today-rows').innerHTML = rows || `<tr><td colspan="5" class="muted">—</td></tr>`;
  }
  window.refreshDashboard = refreshDashboard;

  async function editEntry(id){
    const e = dbCache.entries.find(x=>x.id===id); if(!e) return;
    const ds = prompt('Data (YYYY-MM-DD):', e.start.slice(0,10)); if(!ds) return;
    const ts = prompt('Start (HH:MM):', e.start.slice(11,16)); if(!ts) return;
    const de = prompt('Stop (HH:MM) (lasă gol dacă activ):', e.end? e.end.slice(11,16):'');
    const start = new Date(`${ds}T${ts}:00`);
    let end = null; if(de && de.trim()) end = new Date(`${ds}T${de}:00`).toISOString();
    e.start = start.toISOString(); e.end = end;
    await updateEntryFB(e); refreshDashboard(); runReport();
  }
  window.editEntry = editEntry;

  async function removeEntry(id){ if(!confirm('Ștergi această sesiune?')) return; await removeEntryFB(id); refreshDashboard(); runReport(); }
  window.removeEntry = removeEntry;

  async function createEmployee(){
    const name = document.getElementById('emp-name').value.trim(); if(!name){ alert('Te rog numele.'); return; }
    const role = document.getElementById('emp-role').value.trim();
    const rate = parseFloat(document.getElementById('emp-rate').value||'');
    const emp = { id: gid(), name, role: role||'', rate: isFinite(rate)? rate: null, active: true };
    await upsertEmployee(emp);
    document.getElementById('emp-name').value=''; document.getElementById('emp-role').value=''; document.getElementById('emp-rate').value='';
  }
  window.createEmployee = createEmployee;

  function renderEmployees(){
    const rows = dbCache.employees.map(e=>{
      return `<tr>
        <td>${e.name}</td>
        <td>${e.role||'—'}</td>
        <td>${e.rate!=null? e.rate.toFixed(2): '—'}</td>
        <td>${e.active!==false?'<span class="pill">Activ</span>':'<span class="pill" style="background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35);color:#b91c1c">Inactiv</span>'}</td>
        <td>
          <button class="btn ghost" onclick="editEmployee('${e.id}')">Editează</button>
          <button class="btn ghost" onclick="toggleActive('${e.id}')">${e.active!==false?'Dezactivează':'Activează'}</button>
          <button class="btn danger" onclick="deleteEmployee('${e.id}')">Șterge</button>
        </td>
      </tr>`
    }).join('');
    document.getElementById('emp-rows').innerHTML = rows || `<tr><td colspan="5" class="muted">Adaugă primul lucrător.</td></tr>`;
    document.getElementById('emp-count').textContent = dbCache.employees.length;
  }
  window.renderEmployees = renderEmployees;

  async function editEmployee(id){
    const e = dbCache.employees.find(x=>x.id===id); if(!e) return;
    const name = prompt('Nume:', e.name); if(!name) return;
    const role = prompt('Funcția (opțional):', e.role||'');
    const rate = prompt('Tarif/oră (opțional):', e.rate!=null? e.rate: '');
    const upd = { ...e, name: name.trim(), role: (role||'').trim(), rate: rate!==''? Math.max(0, parseFloat(rate)): null };
    await upsertEmployee(upd);
  }
  window.editEmployee = editEmployee;

  async function toggleActive(id){ const e = dbCache.employees.find(x=>x.id===id); if(!e) return; await toggleActiveFB(id, !(e.active!==false)); }
  window.toggleActive = toggleActive;

  async function deleteEmployee(id){ if(!confirm('Ștergi lucrătorul? (pontajele rămân în istoric)')) return; await deleteEmployeeFB(id); }
  window.deleteEmployee = deleteEmployee;

  async function addManualEntry(){
    const empId = document.getElementById('manual-employee').value;
    const ds = document.getElementById('manual-date').value;
    const ts = document.getElementById('manual-start').value;
    const te = document.getElementById('manual-end').value;
    if(!empId||!ds||!ts||!te){ alert('Completează toate câmpurile.'); return; }
    const start = new Date(`${ds}T${ts}:00`);
    const end = new Date(`${ds}T${te}:00`);
    if(end<=start){ alert('Stop trebuie să fie după start.'); return; }
    if(activeEntryFor(empId)){ alert('Există o sesiune deschisă. Închide-o înainte de a adăuga manual.'); return; }
    await addEntryFB({ id: gid(), employeeId: empId, start: start.toISOString(), end: end.toISOString() });
    document.getElementById('manual-start').value=''; document.getElementById('manual-end').value='';
  }
  window.addManualEntry = addManualEntry;

  function toggleCustomDates(){ const v = document.getElementById('rep-range').value; document.getElementById('rep-custom').classList.toggle('hidden', v!=='custom'); }
  window.toggleCustomDates = toggleCustomDates;

  function getRange(){
    const v = document.getElementById('rep-range').value; const d = now(); let from, to;
    const startOfWeek = (date)=>{ const t = new Date(date); const day=(t.getDay()+6)%7; t.setHours(0,0,0,0); t.setDate(t.getDate()-day); return t; }
    const endOfDay = (date)=>{ const t=new Date(date); t.setHours(23,59,59,999); return t; };
    if(v==='thisWeek'){ from = startOfWeek(d); to = endOfDay(new Date(startOfWeek(d).getTime()+6*86400000)); }
    else if(v==='lastWeek'){ const s = new Date(startOfWeek(d).getTime()-7*86400000); from=s; to=endOfDay(new Date(s.getTime()+6*86400000)); }
    else if(v==='thisMonth'){ from=new Date(d.getFullYear(), d.getMonth(),1); to=endOfDay(new Date(d.getFullYear(), d.getMonth()+1,0)); }
    else if(v==='lastMonth'){ from=new Date(d.getFullYear(), d.getMonth()-1,1); to=endOfDay(new Date(d.getFullYear(), d.getMonth(),0)); }
    else if(v==='thisYear'){ from=new Date(d.getFullYear(),0,1); to=endOfDay(new Date(d.getFullYear(),11,31)); }
    else { const f = document.getElementById('rep-from').value, t = document.getElementById('rep-to').value; if(!f||!t){ alert('Alege intervalul.'); return null; } from = new Date(f+'T00:00:00'); to = endOfDay(new Date(t+'T00:00:00')); }
    return {from,to};
  }

  function runReport(){
    const empSel = document.getElementById('rep-employee').value || 'all';
    const range = getRange(); if(!range) return; const {from,to} = range;
    const filtered = dbCache.entries.filter(e=>{ const s = new Date(e.start); const en = e.end? new Date(e.end): now(); return en>=from && s<=to && (empSel==='all' || e.employeeId===empSel); }).sort((a,b)=> new Date(a.start)-new Date(b.start));
    const rows = filtered.map(e=>{ const emp = dbCache.employees.find(x=>x.id===e.employeeId); const d = new Date(e.start); return `<tr><td>${emp?emp.name:'—'}</td><td>${fmtDate(d)}</td><td>${fmtTime(new Date(e.start))}</td><td>${e.end? fmtTime(new Date(e.end)):'—'}</td><td>${fmtDuration(durationOf(e))}</td></tr>`; }).join('');
    document.getElementById('rep-rows').innerHTML = rows || `<tr><td colspan=\"5\" class=\"muted\">Fără date.</td></tr>`;
    const map = new Map(); filtered.forEach(e=>{ const ms = durationOf(e); map.set(e.employeeId, (map.get(e.employeeId)||0)+ms); });
    const items = []; let grand = 0, grandCost = 0;
    map.forEach((ms, empId)=>{ grand += ms; const emp = dbCache.employees.find(x=>x.id===empId); const hours = (ms/3600000); const cost = emp?.rate!=null? hours*emp.rate: null; if(cost!=null) grandCost += cost; items.push(`<span class=\"pill\">${emp?emp.name:'—'} · ${hours.toFixed(2)}h${cost!=null?` · ${cost.toFixed(2)} EUR`:''}</span>`); });
    const sumHtml = `<div class=\"kpi\"><h3 style=\"margin:0\">Total: ${(grand/3600000).toFixed(2)} ore</h3></div>${grandCost>0? `<span class=\\\"pill\\\">Cost estimat: ${grandCost.toFixed(2)} EUR</span>`:''}`;
    document.getElementById('rep-summary').innerHTML = sumHtml;
  }
  window.runReport = runReport;

  function exportCSV(){
    const empSel = document.getElementById('rep-employee').value || 'all';
    const range = getRange(); if(!range) return; const {from,to}=range;
    const filtered = dbCache.entries.filter(e=>{ const s = new Date(e.start); const en = e.end? new Date(e.end): now(); return en>=from && s<=to && (empSel==='all' || e.employeeId===empSel); }).sort((a,b)=> new Date(a.start)-new Date(b.start));
    const head = ['Employee','Date','Start','End','Duration(h)'];
    const rows = filtered.map(e=>{ const emp=dbCache.employees.find(x=>x.id===e.employeeId); const dur=durationOf(e)/3600000; return [emp?emp.name:'', e.start.slice(0,10), e.start.slice(11,16), e.end? e.end.slice(11,16):'', dur.toFixed(2)]; });
    const csv = [head,...rows].map(r=>r.map(x=>`"${(x||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='raport.csv'; a.click(); URL.revokeObjectURL(url);
  }
  window.exportCSV = exportCSV;

  function durationOf(e){ const s = new Date(e.start).getTime(); const en = (e.end? new Date(e.end): now()).getTime(); return Math.max(0, en - s); }
  function fmtDuration(ms){ const h = Math.floor(ms/3600000); const m = Math.round((ms%3600000)/60000); const pad=(n)=> String(n).padStart(2,'0'); return `${pad(h)}:${pad(m)}`; }

  function exportData(){ const snapshot = { employees: dbCache.employees, entries: dbCache.entries, lastEmployeeId: dbCache.lastEmployeeId, autoOut: dbCache.autoOut }; const blob = new Blob([JSON.stringify(snapshot,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='time-attendance-backup.json'; a.click(); URL.revokeObjectURL(url); }
  window.exportData = exportData;

  async function resetAll(){ if(!confirm('Sigur vrei resetare totală?')) return; await set(ref(rtdb, EMP_NODE), {}); await set(ref(rtdb, 'entries'), {}); await set(ref(rtdb, 'meta'), { lastEmployeeId: null, autoOut: {enabled:false,time:"18:00"} }); }
  window.resetAll = resetAll;

  document.getElementById('import-file').addEventListener('change', async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return; const text = await file.text();
    try{
      const data = JSON.parse(text);
      const employeesObj = (data.employees||[]).reduce((acc,e)=>{ acc[e.id]=e; return acc; },{});
      const entriesObj = (data.entries||[]).reduce((acc,en)=>{ acc[en.id]=en; return acc; },{});
      await set(ref(rtdb, EMP_NODE), employeesObj);
      await set(ref(rtdb, 'entries'), entriesObj);
      await set(ref(rtdb, 'meta/lastEmployeeId'), data.lastEmployeeId || null);
      if(data.autoOut){ await set(ref(rtdb, 'meta/autoOut'), data.autoOut); }
    }catch(err){ alert('Import eșuat: '+err.message); }
  });

  // ===== Auto checkout sweep (runs on load and every 60s) =====
  function timeToDate(date, hhmm){ const [h,m] = (hhmm||'18:00').split(':').map(x=>parseInt(x,10)); const d = new Date(date); d.setHours(h||18, m||0, 0, 0); return d; }
  async function autoCheckoutSweep(){
    const cfg = dbCache.autoOut; if(!cfg?.enabled) return;
    const nowD = now();
    for(const e of dbCache.entries){
      if(e.end!=null) continue;
      const startD = new Date(e.start);
      const cutoff = timeToDate(startD, cfg.time);
      // Retroactiv: închide la cutoff-ul zilei în care a început sesiunea
      if(nowD.getTime() >= cutoff.getTime()){
        e.end = cutoff.toISOString();
        await updateEntryFB(e);
      }
    }
  }
  setInterval(autoCheckoutSweep, 60000);

  // ===== Firebase Real-time listeners with EMP_NODE detection =====
  async function attachListeners(){
    try {
      const wSnap = await get(ref(rtdb, 'workers'));
      if (wSnap.exists() && wSnap.val() && Object.keys(wSnap.val()).length > 0) {
        EMP_NODE = 'workers';
      }
    } catch (e) {}

    onValue(ref(rtdb, EMP_NODE), (snap)=>{
      dbCache.employees = objToArr(snap.val());
      renderEmployees(); populateEmployeeSelects(); renderEmployeePicker(); refreshDashboard();
    });
    onValue(ref(rtdb, 'entries'), (snap)=>{
      dbCache.entries = objToArr(snap.val());
      refreshDashboard(); renderEmployeePicker(); runReport(); autoCheckoutSweep();
    });
    onValue(ref(rtdb, 'meta/lastEmployeeId'), (snap)=>{
      dbCache.lastEmployeeId = snap.val();
      refreshDashboard(); renderEmployeePicker();
    });
    onValue(ref(rtdb, 'meta/autoOut'), (snap)=>{
      dbCache.autoOut = snap.val() || {enabled:false,time:'18:00'};
      const en = document.getElementById('autoout-enabled'); const tt = document.getElementById('autoout-time');
      if(en) en.checked = !!dbCache.autoOut.enabled; if(tt) tt.value = dbCache.autoOut.time || '18:00';
    });
  }

  // ===== Init =====
  (function init(){
    document.getElementById('version').textContent = APP_VERSION + ' • Firebase RTDB';
    const today = new Date(); const fmt = (d)=> d.toISOString().slice(0,10);
    document.getElementById('rep-from').value = fmt(new Date(today.getFullYear(), today.getMonth(), 1));
    document.getElementById('rep-to').value = fmt(today);
    document.getElementById('langSel').value = localStorage.getItem('lang')||'ro';
    applyI18n();
    signInAnonymously(auth).catch(()=>{});
    onAuthStateChanged(auth, (user)=>{ if(user){ attachListeners(); autoCheckoutSweep(); } });
  })();
  </script>
</body>
</html>
